# Technical Architecture

## Scheduled Job

Upon startup, the plugin initiates a scheduled job that runs on a single node within a high-availability (HA) cluster. This job is responsible for ending an ongoing survey and starting a new one if necessary.

Here is the flowchart for the job:

<img src="cron-job.png?raw=true" alt="Cron Job Flow Chart"/>

## Receiving the Survey

The web application component of the plugin makes an API call to the `/connected` endpoint, triggering checks to determine whether to send the survey. Below is the flowchart for the `/connected` API:

<img src="connected-api.png?raw=true" alt="Connected API Flow Chart"/>

## Saving Responses

We save two types of responses: `partial` and `complete`.

- **Partial Response:** This contains only the answer to the system rating question and is updated every time the user clicks on a rating value before clicking the `Submit` button.
- **Complete Response:** This contains the answer to the rating question and, optionally, other questions in the survey. Once saved, a complete response is not updated. Attempts to save it again will result in an error, with no data updated in the database.

When saving any response, if there already exists a complete response for the user-survey combination, we return an error without updating any data. When saving a response, we overwrite any existing partial response in the `user_survey_survey_responses` table and update the promoter, neutral, and detractor counts in the `user_survey_survey` table based on the score received.

## Generating Reports

Survey reports are generated by fetching one page (500 entries) of survey responses at a time and saving them in a temporary CSV file. Once all pages are fetched, the temporary CSVs are combined into a final CSV report file. Additionally, a survey metadata file is created, containing metadata like the NPS score, excluded teams, questions, etc. The final survey report is a zip file containing both the CSV report and the metadata file.

## Cache

To enhance performance and minimize system resource impact, the plugin caches several computation results. Although lacking in-memory cache support, the plugin uses the `PluginKeyValueStore` table as a cache. This approach avoids some computations and indirectly saves multiple trips to the database.

The following items are cached:

1. **Post ID of Survey Sent to a User:** The post ID is stored whenever a survey is sent to the user. This ID is used to update the post when the survey expires or when the user submits a response.
2. **User's Exclusion Status from Teams:** [Validity: 2 hours] If certain teams are excluded from the survey, we check if the user belongs to those teams before sending the survey. This involves fetching all teams the user belongs to and comparing them with the excluded teams. To avoid repetitive checks, the result (whether the user belongs to an excluded team) is cached.

## Dev Build Features

In the development build, certain features work differently to facilitate testing and faster local development.

1. The scheduled job that manages surveys runs every 15 seconds, compared to every 15 minutes in the production build.
2. The date picker in the system console settings page allows selecting any date, including past dates or todayâ€™s date, whereas the production build limits selection to future dates only.
